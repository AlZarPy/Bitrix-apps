{% extends "base.html" %}
{% block title %}Список 10 последних активных сделок{% endblock %}
{% block content %}

<div class="toolbar">
  <a id="toRoot" class="btn" href="#">На главную</a>
  <button id="btnReload" class="btn" type="button">Обновить список</button>
  <a class="btn" href="{% url 'internship_b24:deal_create' %}">Новая сделка</a>
</div>

<h2>Список 10 последних активных сделок</h2>

<div class="table-wrapper">
  <table id="dealsTable" class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Название</th>
        <th>Тип</th>
        <th>Сумма</th>
        <th>Валюта</th>
        <th>Стадия</th>
        <th>Дата начала</th>
        <th>Дата завершения</th>
        <th>Приоритет</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<p id="hint" class="muted"></p>

<script src="https://api.bitrix24.com/api/v1/"></script>
<script>
(function(){
  const tableBody = document.querySelector('#dealsTable tbody');
  const hint = document.getElementById('hint');
  const btnReload = document.getElementById('btnReload');
  const btnHome = document.getElementById('toRoot');

  // "На главную" — остаёмся в том же iFrame
  btnHome.addEventListener('click', (e) => {
    e.preventDefault();
    if (window.BX24 && BX24.reloadWindow) {
      BX24.init(() => BX24.reloadWindow());
    } else {
      window.location.href = "{% url 'internship_b24:index' %}";
    }
  });

  const UF = 'UF_CRM_1760383363428';
  const fmt   = v => (v===null||v===undefined||v===''?'—':String(v));
  const money = (op,c)=> op ? `${op} ${c||''}` : '—';
  const dt    = s => s ? s.split('T')[0].split('-').reverse().join('.') : '—';

  const ensure = () => new Promise(r=>{ if(window.BX24) BX24.init(()=>r()); else r(); });
  const call   = (m,p) => new Promise((res,rej)=>BX24.callMethod(m,p||{},r=>r.error()?rej(r.error()):res(r.data())));

  async function getTypeNames(){
    try {
      const fields = await call('crm.deal.fields');
      const items = (fields && fields.TYPE_ID && Array.isArray(fields.TYPE_ID.items)) ? fields.TYPE_ID.items : [];
      if (items.length) {
        const map = {}; items.forEach(i => map[i.ID] = i.VALUE); return map;
      }
    } catch(_) {}
    try {
      const list = await call('crm.status.entity.items', { entityId: 'DEAL_TYPE' });
      const map = {}; (list||[]).forEach(s => map[s.STATUS_ID] = s.NAME);
      if (Object.keys(map).length) return map;
    } catch(_) {}
    return { GOODS:'Продажа товара', SERVICES:'Продажа услуги', COMPLEX:'Комплексная продажа', SALE:'Продажа' };
  }
  async function getCurrencyNames(){
    const list = await call('crm.currency.list');
    const map = {};
    (list||[]).forEach(c => { map[c.CURRENCY] = (c.FORMAT_STRING || '').replace('#', c.CURRENCY) || c.CURRENCY_NAME || c.CURRENCY; });
    (list||[]).forEach(c => { if(!map[c.CURRENCY]) map[c.CURRENCY] = c.CURRENCY_NAME || c.CURRENCY; });
    return map;
  }
  async function getStageNamesForCategories(categoryIds){
    const uniq = [...new Set(categoryIds)];
    const map = {};
    for (const cid of uniq){
      const ENTITY_ID = (cid && cid !== '0') ? `DEAL_STAGE_${cid}` : 'DEAL_STAGE';
      const statuses = await call('crm.status.list', { filter: { ENTITY_ID } });
      (statuses||[]).forEach(s => map[s.STATUS_ID] = s.NAME);
    }
    return map;
  }
  async function getUserFieldDictionary(){
    const ufs = await call('crm.deal.userfield.list');
    const def = (ufs||[]).find(u => u.FIELD_NAME === UF);
    const map = {};
    if (def && Array.isArray(def.LIST)) def.LIST.forEach(item => map[String(item.ID)] = item.VALUE);
    return map;
  }

  function drawRows(deals, dicts){
    tableBody.innerHTML = '';
    deals.forEach(d => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.ID}</td>
        <td>${fmt(d.TITLE)}</td>
        <td>${fmt(dicts.types[d.TYPE_ID] || d.TYPE_ID)}</td>
        <td>${money(d.OPPORTUNITY, d.CURRENCY_ID)}</td>
        <td>${fmt(dicts.currencies[d.CURRENCY_ID] || d.CURRENCY_ID)}</td>
        <td>${fmt(dicts.stages[d.STAGE_ID] || d.STAGE_ID)}</td>
        <td>${dt(d.BEGINDATE)}</td>
        <td>${dt(d.CLOSEDATE)}</td>
        <td>${fmt(dicts.uf[d[UF]] || d[UF])}</td>
      `;
      tableBody.appendChild(tr);
    });
  }

  async function load(){
    hint.textContent = 'Загрузка…';
    tableBody.innerHTML = '';
    await ensure();

    const list = await call('crm.deal.list', {
      order:  { 'DATE_MODIFY': 'DESC' },
      filter: { 'STAGE_SEMANTIC_ID': 'P' },
      select: ['ID','TITLE','TYPE_ID','OPPORTUNITY','CURRENCY_ID','STAGE_ID','BEGINDATE','CLOSEDATE','CATEGORY_ID', UF]
    });
    const deals = (list||[]).slice(0,10);
    if (!deals.length){ hint.textContent = 'Активных сделок не найдено.'; return; }

    const categoryIds = deals.map(d => d.CATEGORY_ID);
    const [types, currencies, stages, uf] = await Promise.all([
      getTypeNames(), getCurrencyNames(), getStageNamesForCategories(categoryIds), getUserFieldDictionary()
    ]);

    drawRows(deals, { types, currencies, stages, uf });
    hint.textContent = '';
  }

  btnReload.addEventListener('click', load);
  load();
})();
</script>

{% endblock %}
